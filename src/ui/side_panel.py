from PySide6.QtWidgets import (QWidget, QVBoxLayout, QTabWidget,
                               QTreeWidget,QApplication,
                                QMenu)
from PySide6.QtGui import QAction

from parsers.content_cache import ContentCache
from src.managers.dynamic_tabs import DynamicTabManager
from src.observers.file_watcher import FileWatcher
from src.observers.my_base_observer import MyBaseObserver
from src.widgets.markdown_viewer_widget import MarkdownViewer
from PySide6.QtCore import Qt, QRect, QSize
from src.managers.ui_manager import UIManager
from src.managers.toolbar_manager import ToolbarManager
from src.operation.file_operations import FileOperations
from src.managers.tree_model_manager import TreeModelManager
from src.parsers.background_parser import BackgroundParser,Priority
from src.parsers.file_parser_service import FileParserService
from src.parsers.metadata_cache import MetadataCache

class SidePanelObserver(MyBaseObserver):
    # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 29.06.2025
    def __init__(self):
        super().__init__()
class SidePanel(QWidget):
    # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 08.08.2025
        # üèÜtask: –°–æ–∑–¥–∞–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏;
        # üèÜtask: –û—Ç–∫—Ä—ã—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –∏–∑ —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏;
    def __init__(self,parent=None):
        """
            –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –≤–∫–ª–∞–¥–∫–∞–º–∏

            Args:
                tab_names: –°–ø–∏—Å–æ–∫ –∏–º–µ–Ω –¥–ª—è –≤–∫–ª–∞–¥–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ["Documents", "Projects"])
                parent: –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –≤–∏–¥–∂–µ—Ç
        """
        # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 08.08.2025
        super().__init__(parent, Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint)
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤
        self.observer = SidePanelObserver()
        self.file_operation = FileOperations()

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
        self.tab_names = self.file_operation.fetch_file_heararchy()
        if not isinstance(self.tab_names, dict):
            #QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫")  –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ–æ–±—â–µ–Ω–∏–π
            self.tab_names = {"Documents": []}  # fallback

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        self._init_managers()
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π
        self._init_observers()
        # —Ä–∏—Å—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        self._init_ui()
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤
        self._connect_signals()


        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–µ–π
        self._init_position_menu()
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∫ –∫—Ä–∞—è–º —ç–∫—Ä–∞–Ω–∞
        self._setup_screen_edge_docking()
        self.setAttribute(Qt.WA_ShowWithoutActivating)

    def _init_ui(self)->None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 08.08.2025
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –ø–∞–Ω–µ–ª–∏
        self.setMinimumWidth(300)

        self.ui = UIManager()
        self.tree_manager = None # TreeManager(self.tree_view)


        # –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å —Å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–µ–π
        self.splitter = self.ui.create_splitter(Qt.Vertical,
                                                sizes=[300, 100],
                                                handle_width=5,
                                                handle_style="QSplitter::handle { background: #ccc; }")

        # –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π layout
        main_layout = QVBoxLayout(self)
        # –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã —É layout
        main_layout.setContentsMargins(0, 0, 0, 0)

        # –°–æ–∑–¥–∞–µ–º toolbar manager —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
        self.toolbar_manager = ToolbarManager(self.tree_manager, self.close, self.showMinimized)

        # –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        title_layout = self.toolbar_manager.get_title_layout()
        main_layout.addWidget(title_layout)  # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π layout(–º–∞–∫–µ—Ç)

        # –°–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç –≤–∫–ª–∞–¥–æ–∫
        self.tab_widget = self.tab_manager.tab_widget
        self.tab_widget.setTabPosition(QTabWidget.West)  # –í–∫–ª–∞–¥–∫–∏ —Å–ª–µ–≤–∞

        # –°–æ–∑–¥–∞–µ–º –¥–µ—Ä–µ–≤—å—è –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∫–ª–∞–¥–∫–∏
        self._create_tabs_with_trees(self.tab_names)

        # –î–æ–±–∞–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π layout
        main_layout.addWidget(self.tab_widget)

        # –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)
        self.content_viewer = MarkdownViewer()
        # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ (–Ω–∏–∂–Ω—è—è —á–∞—Å—Ç—å)
        self.splitter.addWidget(self.content_viewer)
        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–π layout
        main_layout.addWidget(self.splitter)

    def _init_managers(self)->None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤"""
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 20.08.2025
        # 1. –°–æ–∑–¥–∞–µ–º –∫—ç—à (—Å–∏–Ω–≥–ª—Ç–æ–Ω)
        self.metadata_cache = MetadataCache()
        self.content_cache = ContentCache()  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞

        # 2. –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Å–µ—Ä —Å–µ—Ä–≤–∏—Å
        self.parser_service = FileParserService()

        # 3. –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –º–æ–¥–µ–ª–µ–π —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
        self.tree_model_manager = TreeModelManager(
            parser_service=self.parser_service,
            metadata_cache=self.metadata_cache,
            content_cache=self.content_cache
        )

        # 4. –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä
        self.background_parser = BackgroundParser(
            parser_service=self.parser_service,
            content_cache=self.content_cache
        )
        # 5. –°–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –≤–∫–ª–∞–¥–æ–∫
        self.tab_manager = DynamicTabManager()
        # –í–†–ï–ú–ï–ù–ù–û
        print(f"–¢–∏–ø tab_created: {type(self.tab_manager.tab_created)}")
        print(f"–≠—Ç–æ Signal? {hasattr(self.tab_manager.tab_created, 'connect')}")
        #------ –í–†–ï–ú–ï–ù–ù–û –ö–û–ù–ï–¶
        # 6. –°—Ä–∞–∑—É –ø–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –î–û —Å–æ–∑–¥–∞–Ω–∏—è UI
        self.tab_manager.tab_created.connect(self._on_fill_tab_tree)

    def _init_observers(self)->None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π"""
        self.file_watcher = FileWatcher()
        self.file_watcher.file_updated.connect(self._on_file_updated)
        self.file_watcher.file_deleted.connect(self._on_file_deleted)
        self.file_watcher.dir_changed.connect(self._on_dir_changed)
    def _create_tabs_with_trees(self, tab_name:dict):
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 14.08.2025
        """–°–æ–∑–¥–∞–µ—Ç –≤–∫–ª–∞–¥–∫–∏ —Å –¥–µ—Ä–µ–≤—å—è–º–∏ —Ñ–∞–π–ª–æ–≤"""
        self.tab_manager.create_tabs(tab_name)

    def _connect_signals(self):
        """–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤"""
        # –í–†–ï–ú–ï–ù–ù–û
        print("–ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã...")
        # ------ –í–†–ï–ú–ï–ù–ù–û –ö–û–ù–ï–¶
        self.toolbar_manager.editor_toggled.connect(self._open_editor)
        self.background_parser.task_finished.connect(self._on_parsing_done)
        # –í–†–ï–ú–ï–ù–ù–û
        print("–°–∏–≥–Ω–∞–ª—ã –ø–æ–¥–∫–ª—é—á–µ–Ω—ã")
        # ------ –í–†–ï–ú–ï–ù–ù–û –ö–û–ù–ï–¶
    def _on_file_deleted(self, path):
        """–†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞."""
        # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 08.08.2025
        pass

    def _on_file_updated(self,path):
        """–†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞."""
        # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 08.08.2025
        pass

    def _on_dir_changed(self):
        # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 10.08.2025
        pass

    def _on_fill_tab_tree(self,tab_name: str, tree: QTreeWidget):
        """–ó–∞–ø–æ–ª–Ω—è–µ—Ç –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–∞–º–∏ –∏–∑ —Å–ª–æ–≤–∞—Ä—è tab_names."""
        # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 13.08.2025
        try:
            if tab_name not in self.tab_names:
                return

            # 1. –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏
            file_paths = self.tab_names[tab_name]  # –ù–∞–ø—Ä–∏–º–µ—Ä: ["/path/file1.st", ...]

            # 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
            model = self.tree_model_manager.build_model_for_tab(tab_name, file_paths)

            # 3. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å –∫ –¥–µ—Ä–µ–≤—É
            if model:
                tree.setModel(model)

            # 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥
            for file_path in file_paths:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –ø–æ–ª–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                if not self.content_cache.get(file_path):
                    # –°—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ —Ñ–æ–Ω–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¢–û–õ–¨–ö–û —Ç–µ —Ñ–∞–π–ª—ã,
                    # –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ content_cache
                    # –í–†–ï–ú–ï–ù–ù–û
                    print(f"–î–æ–±–∞–≤–ª—è–µ–º –≤ —Ñ–æ–Ω–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥: {file_path}")
                    # ----------–í–†–ï–ú–ï–ù–ù–û –ö–û–ù–ï–¶
                    self.background_parser.add_task(file_path, Priority.VISIBLE)
                else:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ {tab_name}")
                    # –í–†–ï–ú–ï–ù–ù–û
                    print(f"–§–∞–π–ª —É–∂–µ –≤ –∫—ç—à–µ: {file_path}")
                    # ----------–í–†–ï–ú–ï–ù–ù–û –ö–û–ù–ï–¶
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ—Ä–µ–≤–∞ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ {tab_name}: {e}")

    def _on_parsing_done(self, file_path: str, parsed_data: dict):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞"""
        # –í–†–ï–ú–ï–ù–ù–û
        print(f"–ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω –¥–ª—è: {file_path}")
        print(f"–î–∞–Ω–Ω—ã–µ: {list(parsed_data.keys()) if parsed_data else 'None'}")
        #----------–í–†–ï–ú–ï–ù–ù–û –ö–û–ù–ï–¶

        # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        self.content_cache.set(file_path, parsed_data)

        # 2. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏, –≥–¥–µ –µ—Å—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª
        for tab_name, file_paths in self.tab_names.items():
            if file_path in file_paths:
                # 3. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å
                if tab_name in self.tree_model_manager.tab_models:
                    self.tree_model_manager.update_model(tab_name, file_path)

                    # 4. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º view
                    model = self.tree_model_manager.tab_models[tab_name]
                    model.layoutChanged.emit()


    def _open_editor(self):
        """–û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ñ–∞–π–ª–∞"""
        pass

    # –ú–µ—Ç–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    def _init_position_menu(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.

        –û—Å–Ω–æ–≤–Ω—ã–µ —à–∞–≥–∏ –º–µ—Ç–æ–¥–∞:
        1. –°–æ–∑–¥–∞—ë—Ç –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é (`QMenu`) —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º "–ü–æ–∑–∏—Ü–∏—è –ø–∞–Ω–µ–ª–∏".
        2. –°–æ–∑–¥–∞—ë—Ç —Ç—Ä–∏ –¥–µ–π—Å—Ç–≤–∏—è (`QAction`) —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–ª–∞–∂–∫–∞:
            - "–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ª–µ–≤–∞" (`self.pin_left_action`): –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–∫—Ä–µ–ø–∏—Ç—å –ø–∞–Ω–µ–ª—å —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É `self._dock_to_left`.
            - "–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ø—Ä–∞–≤–∞" (`self.pin_right_action`): –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–∫—Ä–µ–ø–∏—Ç—å –ø–∞–Ω–µ–ª—å —É –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É `self._dock_to_right`.
            - "–°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ" (`self.float_action`): –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–∞–Ω–µ–ª—å –≤ –ø–ª–∞–≤–∞—é—â–∏–π —Ä–µ–∂–∏–º, –∫–æ–≥–¥–∞ –µ—ë –º–æ–∂–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É `self._enable_floating`.
        3. –î–æ–±–∞–≤–ª—è–µ—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –º–µ–Ω—é (`self.position_menu.addActions`).
        4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–ª—è –ø–∞–Ω–µ–ª–∏ –ø–æ–ª–∏—Ç–∏–∫—É –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é (`Qt.CustomContextMenu`).
        5. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –≤—ã–∑–æ–≤–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é (`self.customContextMenuRequested.connect(self.show_context_menu)`), —á—Ç–æ–±—ã –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –º–µ–Ω—é –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –º–µ–Ω—é —Å –¥–µ–π—Å—Ç–≤–∏—è–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.

        –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –º–µ—Ç–æ–¥ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —É–¥–æ–±–Ω–æ–µ –∏ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω–æ–µ –º–µ–Ω—é, –ø–æ–∑–≤–æ–ª—è—é—â–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—ã—Å—Ç—Ä–æ –º–µ–Ω—è—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –µ—ë –≤ –ø–ª–∞–≤–∞—é—â–∏–π —Ä–µ–∂–∏–º —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é.

        """
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 30.06.2025
        # –°–æ–∑–¥–∞–µ–º –º–µ–Ω—é —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
        self.position_menu = QMenu("–ü–æ–∑–∏—Ü–∏—è –ø–∞–Ω–µ–ª–∏", self)

        # –°–æ–∑–¥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ "–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ª–µ–≤–∞"
        self.pin_left_action = QAction("–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ª–µ–≤–∞", self, checkable=True)
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        self.pin_left_action.triggered.connect(self._dock_to_left)

        # –°–æ–∑–¥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ "–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ø—Ä–∞–≤–∞"
        self.pin_right_action = QAction("–ó–∞–∫—Ä–µ–ø–∏—Ç—å —Å–ø—Ä–∞–≤–∞", self, checkable=True)
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        self.pin_right_action.triggered.connect(self._dock_to_right)

        # –°–æ–∑–¥–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ "–°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ"
        self.float_action = QAction("–°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ", self, checkable=True)
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        self.float_action.triggered.connect(self._enable_floating)

        # –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏—è –≤ –º–µ–Ω—é
        self.position_menu.addActions([self.pin_left_action, self.pin_right_action, self.float_action])
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        self.setContextMenuPolicy(Qt.CustomContextMenu)
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        self.customContextMenuRequested.connect(self.show_context_menu) #TODO –Ω–µ—Ç –º–µ—Ç–æ–¥–∞ show_context_menu

    def _dock_to_left(self):
        """
        –ó–∞–∫—Ä–µ–ø–ª—è–µ—Ç –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

        –î–µ–π—Å—Ç–≤–∏—è –º–µ—Ç–æ–¥–∞:
        1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞—Ç—Ä–∏–±—É—Ç `self.dock_position` –≤ –∑–Ω–∞—á–µ–Ω–∏–µ "left", —á—Ç–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–∞–Ω–µ–ª—å –≤ —Ä–µ–∂–∏–º –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–ª–µ–≤–∞.
        2. –í—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ `self.update_dock_position()`, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—é –∏ —Ä–∞–∑–º–µ—Ä—ã –ø–∞–Ω–µ–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –æ—Ç—Å—Ç—É–ø–æ–≤.
        3. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –º–µ–Ω—é —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ `self._update_menu_checks()`, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–æ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª–æ–∂–µ–Ω–∏—é –ø–∞–Ω–µ–ª–∏.

        –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–ª–µ–≤–∞.
        """
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 30.06.2025
        self.dock_position = "left"
        self.update_dock_position()
        self._update_menu_checks()

        # –ú–µ—Ç–æ–¥ –¥–ª—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —Å–ø—Ä–∞–≤–∞
    def _dock_to_right(self):
        """
        –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

        –î–µ–π—Å—Ç–≤–∏—è –º–µ—Ç–æ–¥–∞:
        1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–∂–∏–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ (`self.dock_position`) –≤ –∑–Ω–∞—á–µ–Ω–∏–µ "right", —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —É –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞.
        2. –í—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ `self.update_dock_position()`, –∫–æ—Ç–æ—Ä—ã–π –æ–±–Ω–æ–≤–ª—è–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—é –∏ —Ä–∞–∑–º–µ—Ä—ã –ø–∞–Ω–µ–ª–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–æ–≤—ã–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º. –ü–∞–Ω–µ–ª—å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –ø–æ —à–∏—Ä–∏–Ω–µ –∏ –≤—ã—Å–æ—Ç–µ –∏ —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –≤–ø–ª–æ—Ç–Ω—É—é –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é —Å —É—á–µ—Ç–æ–º –æ—Ç—Å—Ç—É–ø–∞.
        3. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ –≤ –º–µ–Ω—é —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ `self._update_menu_checks()`, —á—Ç–æ–±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –æ—Ç—Ä–∞–∑–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        –¢–∞–∫–æ–π –ø–æ—Ä—è–¥–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –≤—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–æ–∂–µ–Ω–∏—è.
        """
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 30.06.2025
        self.dock_position = "right"
        self.update_dock_position()
        self._update_menu_checks()

    # –ú–µ—Ç–æ–¥ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    def _enable_floating(self):

        # TODO üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ: 11.08.2025
        self.update_dock_position = "float"
        self.setWindowFlags(Qt.Window | Qt.WindowStaysOnTopHint)
        self.setWindowTitle("–ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å")  # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–∫–Ω–∞
        # –°–Ω–∏–º–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –∑–∞–¥–∞–µ–º –¥–æ–ø—É—Å—Ç–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
        self.setMinimumSize(200, 200)  # –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        self.setMaximumSize(16777215, 16777215)  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω)

        self.show()

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –ø–æ–∑–∏—Ü–∏—é
        screen = QApplication.primaryScreen().availableGeometry()
        self.setGeometry(QRect(
                    screen.right() - 350,  # X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ (–Ω–µ–º–Ω–æ–≥–æ –ª–µ–≤–µ–µ –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è)
                    screen.top() + 100,  # Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ (–Ω–µ–º–Ω–æ–≥–æ –Ω–∏–∂–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∫—Ä–∞—è)
                    300,  # –®–∏—Ä–∏–Ω–∞
                    screen.height() - 200  # –í—ã—Å–æ—Ç–∞ (–º–µ–Ω—å—à–µ –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞)
                    ))
        # –°–Ω–∏–º–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã


        self._update_menu_checks()

    # –ú–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –ø–∞–Ω–µ–ª–∏

    def update_dock_position(self):
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ —Ä–∞–∑–º–µ—Ä –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∞.

        –ú–µ—Ç–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ (`self.dock_position`) –∏ –∏–∑–º–µ–Ω—è–µ—Ç –µ—ë –≥–µ–æ–º–µ—Ç—Ä–∏—é –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —ç—Ç–∏–º —Ä–µ–∂–∏–º–æ–º:

         - –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ —Å–ª–µ–≤–∞ (`"left"`):
            - –ü–∞–Ω–µ–ª—å —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ —Å —É—á—ë—Ç–æ–º –æ—Ç—Å—Ç—É–ø–∞ (`self.dock_margin`).
            - –í—ã—Å–æ—Ç–∞ –ø–∞–Ω–µ–ª–∏ —Ä–∞–≤–Ω–∞ –≤—ã—Å–æ—Ç–µ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ —ç–∫—Ä–∞–Ω–∞, —à–∏—Ä–∏–Ω–∞ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 300 –ø–∏–∫—Å–µ–ª–µ–π.
            - –í—ã—Å–æ—Ç–∞ —Ç–∞–∫–∂–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è ‚Äî –ø–∞–Ω–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ –ø–æ –≤—ã—Å–æ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
            - –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ —Å–ø—Ä–∞–≤–∞ (`"right"`):
            - –ü–∞–Ω–µ–ª—å —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —É –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞ —Å —É—á—ë—Ç–æ–º —à–∏—Ä–∏–Ω—ã –ø–∞–Ω–µ–ª–∏ –∏ –æ—Ç—Å—Ç—É–ø–∞.
            - –í—ã—Å–æ—Ç–∞ –∏ —à–∏—Ä–∏–Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ª–µ–≤–æ–º—É –ø–æ–ª–æ–∂–µ–Ω–∏—é.
         - –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –≤ –ø–ª–∞–≤–∞—é—â–µ–º —Ä–µ–∂–∏–º–µ (`"float"`):
            - –î–ª—è –ø–∞–Ω–µ–ª–∏ —Å–Ω–∏–º–∞—é—Ç—Å—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä (200x200 –ø–∏–∫—Å–µ–ª–µ–π).
            - –§–∏–∫—Å–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–≤–æ–±–æ–¥–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä—ã –ø–∞–Ω–µ–ª–∏.

        –¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –∏ –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏.


        """
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 30.06.2025
        # –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é —ç–∫—Ä–∞–Ω–∞
        screen = QApplication.primaryScreen().availableGeometry()
        # –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–ª–µ–≤–∞
        if self.dock_position == "left":
            self.setGeometry(QRect(
                screen.left() + self.dock_margin,  # X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
                screen.top(),  # Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
                300,  # –®–∏—Ä–∏–Ω–∞
                screen.height()  # –í—ã—Å–æ—Ç–∞
            ))
            self.setFixedWidth(300)  # –§–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –≤ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
            self.setFixedHeight(screen.height())  # –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É
            # –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–ø—Ä–∞–≤–∞
        elif self.dock_position == "right":
            self.setGeometry(QRect(
                screen.right() - 300 - self.dock_margin,  # X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
                screen.top(),  # Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞
                300,  # –®–∏—Ä–∏–Ω–∞
                screen.height()  # –í—ã—Å–æ—Ç–∞
            ))
            self.setFixedWidth(300)  # –§–∏–∫—Å–∏—Ä—É–µ–º —à–∏—Ä–∏–Ω—É –≤ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
            self.setFixedHeight(screen.height())  # –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É
            # –î–ª—è —Ä–µ–∂–∏–º–∞ float –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
        elif self.dock_position == "float":
            self.setMinimumSize(200, 200)
            self.setMaximumSize(16777215, 16777215)
            self.setFixedSize(QSize())  # –°–Ω–∏–º–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã

    # –ú–µ—Ç–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é
    def _update_menu_checks(self):
        """
            –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤ (—Ñ–ª–∞–∂–∫–æ–≤) –≤ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏.

            –î–ª—è –∫–∞–∂–¥–æ–π –∏–∑ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –ø–∞–Ω–µ–ª–∏ (—Å–ª–µ–≤–∞, —Å–ø—Ä–∞–≤–∞, –ø–ª–∞–≤–∞—é—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ) —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —á–µ–∫–±–æ–∫—Å –≤ –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–∞–Ω–µ–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç c –¥–∞–Ω–Ω–æ–π.
            –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–Ω—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª–æ–∂–µ–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

            - –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ —Å–ª–µ–≤–∞, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—É–Ω–∫—Ç 'Pin Left'.
            - –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ —Å–ø—Ä–∞–≤–∞, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—É–Ω–∫—Ç 'Pin Right'.
            - –ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–ª–∞–≤–∞—é—â–µ–º —Ä–µ–∂–∏–º–µ, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—É–Ω–∫—Ç 'Float'.

            –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –º–µ—Ç–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º –ø–∞–Ω–µ–ª–∏.

        """
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 30.06.2025
        self.pin_left_action.setChecked(self.dock_position == "left")
        self.pin_right_action.setChecked(self.dock_position == "right")
        self.float_action.setChecked(self.dock_position == "float")

    def show_context_menu(self, pos):
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 11.08.2025
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
        self.position_menu.exec(self.mapToGlobal(pos))

    def _setup_screen_edge_docking(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏—è –∫ –∫—Ä–∞—è–º —ç–∫—Ä–∞–Ω–∞"""
        # ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: 30.06.2025
        # –ü–æ–∑–∏—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - —Å–ø—Ä–∞–≤–∞
        self.dock_position = "right"  # left/right/float
        # –û—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è —ç–∫—Ä–∞–Ω–∞
        self.dock_margin = 5

        self.setWindowFlags(self.windowFlags() & ~Qt.WindowStaysOnTopHint)  # <- –û–¢–ö–õ–Æ–ß–ê–ï–ú –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö –æ–∫–æ–Ω
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
        self.update_dock_position()
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –æ–∫–Ω–∞
        self.setWindowOpacity(0.9)

    def set_manedger(self,tree_model_manager:TreeModelManager):
        self.tree_model_manager = tree_model_manager