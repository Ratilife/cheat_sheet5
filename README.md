# Надстройка Markdown для Microsoft Word (VSTO)

Этот репозиторий содержит исходники каркаса (scaffold) VSTO‑надстройки для Microsoft Word, которая предоставляет редактор Markdown и живой предпросмотр в панели задач, а также команды на ленте (Ribbon) и базовые операции открытия/сохранения `.md`.

- **Панель задач** с WebView2: слева редактор (textarea), справа превью
- **Рендер Markdown → HTML** на .NET через Markdig
- **Подсветка кода** (Prism.js), **Mermaid** (диаграммы), **MathJax** (формулы), **DOMPurify** (санитизация HTML)
- **Вкладка “Markdown”** на ленте с кнопками для вставки синтаксиса (жирный, курсив, списки, таблицы, ссылки, изображения, код‑блок, Mermaid, формулы, разделители)
- **Открытие/Сохранение `.md`** с кодировкой UTF‑8
- **Хранение Markdown внутри документа** Word в `CustomXMLPart` (namespace `urn:markdown/source`)

## Стек и архитектура
- **Платформа**: Microsoft Word VSTO Add‑in (C#, .NET Framework 4.8)
- **Предпросмотр**: WebView2 (Edge runtime)
- **Markdown**: Markdig (C#)
- **Клиентские библиотеки**: Prism.js, Mermaid, MathJax, DOMPurify (загружаются из CDN в HTML‑оболочке превью)

## Предварительные требования (Windows)
- Microsoft Word 2016/2019/2021/365 (x64 рекомендуется)
- Windows 10/11
- Visual Studio 2022 (Community/Pro/Enterprise)
  - Рабочая нагрузка: Office/SharePoint development
- .NET Framework 4.8 Developer Pack
- WebView2 Runtime (Evergreen)
- Опционально: Pandoc (для расширенных конвертаций DOCX→MD)

## Быстрый старт (рекомендуемый способ)
1. Откройте Visual Studio на Windows.
2. Создайте новый проект: «Word VSTO Add‑in» (.NET Framework). Имя проекта — `WordMarkdownAddIn`.
3. Закройте автоматически созданные шаблонные файлы (например, дефолтный `ThisAddIn.cs`, Ribbon и т. п.), если они не нужны.
4. В обозревателе решений (Solution Explorer) добавьте файлы из этого репозитория в проект:
   - `WordMarkdownAddIn/ThisAddIn.cs`
   - `WordMarkdownAddIn/ThisAddIn.Designer.cs`
   - `WordMarkdownAddIn/Ribbon.cs`
   - `WordMarkdownAddIn/Controls/TaskPaneControl.cs`
   - `WordMarkdownAddIn/Services/MarkdownRenderService.cs`
   - `WordMarkdownAddIn/Services/DocumentSyncService.cs`
   - `WordMarkdownAddIn/Properties/AssemblyInfo.cs` (по желанию, чтобы переопределить метаданные)
   Убедитесь, что пространства имён совпадают с корневым пространством имён проекта (обычно `WordMarkdownAddIn`).
5. Установите NuGet‑пакеты в проект VSTO:
   - `Markdig` (последняя стабильная)
   - `Microsoft.Web.WebView2` (последняя стабильная)
   - `Microsoft.Office.Interop.Word` (если шаблон не добавил сам)
   - (Опционально) `NLog`
6. Соберите решение. Visual Studio сгенерирует необходимые артефакты VSTO.
7. Запустите отладку (F5). Word стартует с подключённой надстройкой. На ленте появится вкладка `Markdown`.

## Возможности каркаса
- Автопоказ панели задач `Markdown` при запуске
- Редактор Markdown (textarea) и живой превью с дебаунсом изменений
- Рендер через Markdig на .NET; пост‑обработка Mermaid‑блоков
- Подсветка кода Prism.js (автозагрузка языков), рендер Mermaid и MathJax, санитизация HTML DOMPurify
- Кнопки ленты (Ribbon) для вставки MD‑конструкций:
  - Панель (вкл/выкл), Открыть `.md`, Сохранить `.md`
  - Жирный, Курсив, Зачёркнутый, Моноширинный
  - Заголовок H1, Маркированный/Нумерованный список, Чекбокс
  - Таблица, Ссылка, Изображение, Горизонтальный разделитель
  - Код‑блок (с языком), Mermaid‑блок, Формула (MathJax)
- Источник Markdown сохраняется в активном документе Word (`CustomXMLPart`, `urn:markdown/source`) и автоматически обновляется перед сохранением документа

## Как использовать
- Печатайте/вставляйте Markdown слева в редакторе; предпросмотр справа обновляется автоматически.
- Кнопки на вкладке `Markdown` добавляют соответствующие конструкции в редактор.
- «Открыть .md» и «Сохранить .md» работают с файлами на диске (UTF‑8, без BOM по умолчанию).
- При сохранении документа Word текущий Markdown записывается во внутренний `CustomXMLPart`.

## Примечания по безопасности
- Встроенные HTML‑вставки из Markdown проходят санитизацию (DOMPurify). Разрешённый набор атрибутов ограничен.
- Mermaid и MathJax работают в режиме по умолчанию; при необходимости можно ужесточить настройки (например, `securityLevel` у Mermaid и CSP для WebView2).

## Известные ограничения
- Проектный файл `.csproj` для VSTO не включён. Создайте проект через шаблон Visual Studio и добавьте исходники из этого репозитория.
- Полный круговой трансфер Word↔Markdown не гарантируется. Для сложных DOCX рекомендуется использовать Pandoc (вне рамок каркаса).
- Требуется установленный WebView2 Runtime. Без него превью будет пустым.

## Удаление / Очистка
- Перед пересборкой закройте все экземпляры Word.
- Visual Studio автоматически регистрирует/дерегистрирует надстройку при Debug‑запусках.

## Устранение неполадок
- Пустая панель превью: проверьте установку WebView2 Runtime (Evergreen).
- Вкладка не отображается: Файл → Параметры → Надстройки → Управление: «COM‑надстройки» → убедитесь, что надстройка загружена.
- Ошибки ссылок/зависимостей: переустановите Office Developer Tools и проверьте ссылки на PIA (Primary Interop Assemblies).

## Дальнейшее развитие (опционально)
- Горячие клавиши и контекстное меню Word
- Локализация (RU/EN) и синхронизация с тёмной/светлой темой Word
- Интеграция с Pandoc для расширенного экспорта DOCX→MD
- Вставка изображений из буфера/drag‑and‑drop с сохранением в `assets/` рядом с `.md` и относительными путями